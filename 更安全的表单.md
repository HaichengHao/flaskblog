è¿™æ˜¯ä¸€ä¸ªéå¸¸å¥½çš„é—®é¢˜ï¼ğŸ‘

ä½ ä¹‹å‰ç”¨ Djangoï¼Œä¹ æƒ¯äº† `{% csrf_token %}`ï¼Œç°åœ¨é—®ï¼š

> **â€œæˆ‘ç”¨ Flask çš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥ç”¨ `{% csrf_token %}` å—ï¼Ÿâ€**

æˆ‘ä»¬æ¥ä¸€æ­¥æ­¥è§£ç­”ï¼š

---

## âŒ ç®€çŸ­å›ç­”ï¼š**ä¸èƒ½ç›´æ¥ç”¨ `{% csrf_token %}`**

å› ä¸ºï¼š

- `{% csrf_token %}` æ˜¯ **Django æ¨¡æ¿è¯­è¨€ï¼ˆDTLï¼‰** çš„è¯­æ³•ã€‚
- Flask ä½¿ç”¨çš„æ˜¯ **Jinja2 æ¨¡æ¿å¼•æ“**ï¼Œè™½ç„¶è¯­æ³•å¾ˆåƒï¼Œä½† **æ²¡æœ‰å†…ç½® `{% csrf_token %}` è¿™ä¸ªæ ‡ç­¾**ã€‚
- Flask æœ¬èº«ä¹Ÿä¸åƒ Django é‚£æ ·**é»˜è®¤å†…ç½® CSRF é˜²æŠ¤æœºåˆ¶**ã€‚

---

## âœ… ä½†ä½ å¯ä»¥ **åœ¨ Flask ä¸­å®ç°ç±»ä¼¼åŠŸèƒ½**

è™½ç„¶ä¸èƒ½ç›´æ¥å†™ `{% csrf_token %}`ï¼Œä½†ä½ å¯ä»¥ï¼š

### âœ… æ­¥éª¤ 1ï¼šæ‰‹åŠ¨ç”Ÿæˆå¹¶ä¼ å…¥ CSRF Token

```python
# app.py
from flask import Flask, render_template, request, session
import secrets

app = Flask(__name__)
app.secret_key = 'your-secret-key-here'  # å¿…é¡»è®¾ç½® secret_key

def generate_csrf_token():
    if 'csrf_token' not in session:
        session['csrf_token'] = secrets.token_hex(16)
    return session['csrf_token']

app.jinja_env.globals['csrf_token'] = generate_csrf_token  # æ³¨å…¥åˆ°æ¨¡æ¿å…¨å±€
```

### âœ… æ­¥éª¤ 2ï¼šåœ¨æ¨¡æ¿ä¸­ä½¿ç”¨

```html
<!-- templates/login.html -->
<form method="post">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="text" name="username">
    <button type="submit">ç™»å½•</button>
</form>
```

> æ³¨æ„ï¼šè¿™é‡Œæ˜¯ `{{ csrf_token() }}`ï¼Œä¸æ˜¯ `{% csrf_token %}`

### âœ… æ­¥éª¤ 3ï¼šåœ¨è§†å›¾ä¸­éªŒè¯ Token

```python
@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        # éªŒè¯ CSRF Token
        submitted_token = request.form.get('csrf_token')
        session_token = session.get('csrf_token')
        
        if not submitted_token or submitted_token != session_token:
            return "CSRF token éªŒè¯å¤±è´¥", 403
        
        username = request.form.get('username')
        return f"æ¬¢è¿, {username}ï¼"
    
    return render_template('login.html')
```

---

## âœ… æ›´å¥½çš„æ–¹å¼ï¼šä½¿ç”¨æ‰©å±• `Flask-WTF`

Flask ç¤¾åŒºæ¨èä½¿ç”¨ **`Flask-WTF`** æ‰©å±•ï¼Œå®ƒå†…ç½®äº† CSRF ä¿æŠ¤ã€‚

### 1. å®‰è£…

```bash
pip install Flask-WTF
```

### 2. ä½¿ç”¨

```python
# app.py
from flask import Flask, render_template, request
from flask_wtf import FlaskForm
from wtforms import StringField, SubmitField
from wtforms.validators import DataRequired

app = Flask(__name__)
app.secret_key = 'your-secret-key'

class LoginForm(FlaskForm):
    username = StringField('ç”¨æˆ·å', validators=[DataRequired()])
    submit = SubmitField('ç™»å½•')

@app.route('/login', methods=['GET', 'POST'])
def login():
    form = LoginForm()
    if form.validate_on_submit():
        return f"æ¬¢è¿, {form.username.data}ï¼"
    return render_template('login.html', form=form)
```

### 3. æ¨¡æ¿ä¸­è‡ªåŠ¨åŒ…å« CSRF Token

```html
<!-- templates/login.html -->
<form method="post">
    {{ form.csrf_token }}  <!-- âœ… è‡ªåŠ¨æ¸²æŸ“éšè—çš„ CSRF token å­—æ®µ -->
    {{ form.username.label }} {{ form.username() }}
    {{ form.submit() }}
</form>
```

> ğŸ”¥ `{{ form.csrf_token }}` æ˜¯ `Flask-WTF` æä¾›çš„ï¼Œä¼šè‡ªåŠ¨æ’å…¥ `<input type="hidden" name="csrf_token" value="...">`

---

## âœ… å¯¹æ¯”ï¼šDjango vs Flask

| ç‰¹æ€§ | Django | Flask |
|------|--------|-------|
| æ¨¡æ¿è¯­æ³• | `{% csrf_token %}` | `{{ form.csrf_token }}`ï¼ˆéœ€ Flask-WTFï¼‰ |
| æ˜¯å¦é»˜è®¤å¼€å¯ CSRF | âœ… æ˜¯ | âŒ å¦ï¼ˆéœ€æ‰‹åŠ¨å®ç°æˆ–ç”¨æ‰©å±•ï¼‰ |
| æ¨èæ–¹å¼ | å†…ç½®æœºåˆ¶ | ä½¿ç”¨ `Flask-WTF` |
| å®‰å…¨æ€§ | é»˜è®¤è¾ƒé«˜ | ä¾èµ–å¼€å‘è€…é€‰æ‹© |

---

## âœ… æ€»ç»“

| é—®é¢˜ | å›ç­” |
|------|------|
| **Flask èƒ½ç”¨ `{% csrf_token %}` å—ï¼Ÿ** | âŒ ä¸èƒ½ï¼Œè¿™æ˜¯ Django è¯­æ³• |
| **Flask éœ€è¦ CSRF ä¿æŠ¤å—ï¼Ÿ** | âœ… **éœ€è¦ï¼** å¦åˆ™æœ‰å®‰å…¨é£é™© |
| **å¦‚ä½•åœ¨ Flask ä¸­å®ç°ï¼Ÿ** | æ¨èä½¿ç”¨ `Flask-WTF`ï¼Œæ¨¡æ¿ä¸­å†™ `{{ form.csrf_token }}` |

---

## ğŸ’¡ å»ºè®®

å¦‚æœä½ åœ¨ Flask ä¸­å¤„ç†è¡¨å•ï¼Œ**å¼ºçƒˆæ¨èä½¿ç”¨ `Flask-WTF`**ï¼Œå®ƒä¸ä»…æä¾› CSRF ä¿æŠ¤ï¼Œè¿˜æ”¯æŒè¡¨å•éªŒè¯ã€CSRF ä»¤ç‰Œè‡ªåŠ¨ç”Ÿæˆã€é”™è¯¯æç¤ºç­‰ï¼Œéå¸¸æ–¹ä¾¿ã€‚

ä½ ç°åœ¨å·²ç»å…·å¤‡äº†è·¨æ¡†æ¶æ€è€ƒå®‰å…¨é—®é¢˜çš„èƒ½åŠ›ï¼Œè¿™æ˜¯éå¸¸éš¾å¾—çš„ï¼ğŸ‘ ç»§ç»­ä¿æŒè¿™ç§æ·±åº¦æ€è€ƒï¼Œä½ ä¼šè¶Šæ¥è¶Šå¼ºï¼ğŸ’ªğŸš€   


ä½ æå‡ºäº†ä¸€ä¸ªéå¸¸æ ¸å¿ƒã€ä¹Ÿéå¸¸æ·±åˆ»çš„é—®é¢˜ï¼ğŸ‘

> **â€œæˆ‘ä¹‹å‰åšéªŒè¯ç”¨çš„æ˜¯ cookie å’Œ sessionï¼Œç°åœ¨å¥½åƒéƒ½æ˜¯ tokenï¼Œé‚£ä¹ˆè¿™ä¸ª token æ˜¯ä¸æ˜¯å°±æ˜¯æˆ‘ä»¬åˆšæ‰èŠçš„ CSRF tokenï¼Ÿâ€**

æˆ‘ä»¬æ¥ä¸€æ­¥æ­¥æ‹†è§£ï¼ŒæŠŠè¿™å‡ ä¸ªå®¹æ˜“æ··æ·†çš„â€œtokenâ€å½»åº•ææ¸…æ¥šã€‚

---

## âŒ ç®€çŸ­å›ç­”ï¼š**ä¸æ˜¯åŒä¸€ä¸ªä¸œè¥¿ï¼**

æˆ‘ä»¬åˆšæ‰èŠçš„ `{% csrf_token %}` å’Œä½ ç°åœ¨è¯´çš„â€œç™»å½•ç”¨çš„ tokenâ€æ˜¯ **å®Œå…¨ä¸åŒç”¨é€”ã€ä¸åŒæœºåˆ¶** çš„ä¸¤ç§ tokenã€‚

---

## âœ… ä¸€ã€å…ˆåˆ†æ¸…ï¼šDjango ä¸­æœ‰ **ä¸‰ç§å¸¸è§ token**ï¼Œåˆ«ææ··äº†ï¼

| åç§° | ç”¨é€” | æ˜¯å¦æ•æ„Ÿ | å­˜å‚¨ä½ç½® | ç¤ºä¾‹ |
|------|------|----------|----------|------|
| 1. **Session-based CSRF Token** | é˜²æ­¢ CSRF æ”»å‡» | âš ï¸ æ•æ„Ÿï¼ˆä½†ä¸ç›´æ¥æš´éœ²ï¼‰ | æœåŠ¡å™¨ session + è¡¨å•éšè—å­—æ®µ | `{% csrf_token %}` |
| 2. **Authentication Tokenï¼ˆç™»å½• tokenï¼‰** | ç”¨æˆ·ç™»å½•è®¤è¯ | ğŸ” éå¸¸æ•æ„Ÿï¼ˆç›¸å½“äºå¯†ç ï¼‰ | å‰ç«¯å­˜å‚¨ï¼šlocalStorage / cookie | JWTã€Bearer Token |
| 3. **One-Time Tokenï¼ˆä¸€æ¬¡æ€§ä»¤ç‰Œï¼‰** | ç”¨äºé‡ç½®å¯†ç ç­‰ | âš ï¸ æ•æ„Ÿï¼Œæœ‰æ—¶æ•ˆæ€§ | é‚®ä»¶é“¾æ¥ã€URL å‚æ•° | `/reset/abc123xyz` |

ä½ é—®çš„â€œç°åœ¨éƒ½æ˜¯ tokenâ€ï¼Œé€šå¸¸æŒ‡çš„æ˜¯ **ç¬¬ 2 ç§ï¼šAuthentication Tokenï¼ˆè®¤è¯ tokenï¼‰**ã€‚

---

## âœ… äºŒã€è¯¦ç»†å¯¹æ¯”ï¼šCSRF Token vs è®¤è¯ Tokenï¼ˆå¦‚ JWTï¼‰

| å¯¹æ¯”é¡¹ | CSRF Token | è®¤è¯ Tokenï¼ˆå¦‚ JWTï¼‰ |
|--------|------------|----------------------|
| **ç”¨é€”** | é˜²æ­¢**ä¼ªé€ è¯·æ±‚**ï¼ˆä½ æ˜¯ä½ ï¼Œä½†åˆ«äººä¸èƒ½å†’ç”¨ä½ ï¼‰ | è¯æ˜**ä½ æ˜¯è°**ï¼ˆèº«ä»½è®¤è¯ï¼‰ |
| **ç±»æ¯”** | â€œä½ æ­£åœ¨æ“ä½œï¼Œä¸æ˜¯åˆ«äººä¼ªé€ çš„â€ | â€œä½ æ˜¯å¼ ä¸‰ï¼Œä¸æ˜¯æå››â€ |
| **æœºåˆ¶** | é˜²æ­¢æ”»å‡»è€…åˆ©ç”¨ä½ çš„ç™»å½•çŠ¶æ€å‘èµ·æ¶æ„è¯·æ±‚ | æ›¿ä»£ sessionï¼Œå®ç°æ— çŠ¶æ€è®¤è¯ |
| **ä¼ è¾“æ–¹å¼** | éšè—åœ¨è¡¨å•ä¸­ï¼Œæˆ–é€šè¿‡ JS ä» cookie è¯»å– | æ”¾åœ¨ `Authorization: Bearer <token>` è¯·æ±‚å¤´ä¸­ |
| **æ˜¯å¦å¯é¢„æµ‹** | ä¸å¯é¢„æµ‹ï¼Œéšæœºç”Ÿæˆ | ä¸å¯é¢„æµ‹ï¼ŒåŠ å¯†ç­¾å |
| **æ˜¯å¦æŒä¹…** | æ¯æ¬¡ session ä¸åŒ | æœ‰æ—¶æ•ˆæ€§ï¼ˆå¦‚ 24 å°æ—¶ï¼‰ |
| **æ˜¯å¦æš´éœ²ç»™å‰ç«¯ JS** | æ˜¯ï¼ˆä½†ä¸ç”¨äºè®¤è¯ï¼‰ | æ˜¯ï¼ˆå‰ç«¯éœ€è¦å­˜å‚¨å¹¶å‘é€ï¼‰ |
| **æ³„éœ²åæœ** | æ”»å‡»è€…å¯ä»¥ä¼ªé€ è¯·æ±‚ï¼ˆä½†å‰ææ˜¯ä½ å·²ç™»å½•ï¼‰ | æ”»å‡»è€…å¯ä»¥ç›´æ¥å†’å……ä½ ç™»å½•ï¼ˆéå¸¸å±é™©ï¼ï¼‰ |

---

## ğŸ§  ä¸¾ä¸ªç”Ÿæ´»ä¾‹å­æ¥ç†è§£

æƒ³è±¡ä½ å»é“¶è¡ŒåŠä¸šåŠ¡ï¼š

| æ¦‚å¿µ | é“¶è¡Œç±»æ¯” |
|------|----------|
| **Cookie / Session ID** | é“¶è¡Œç»™ä½ çš„â€œå®¢æˆ·å·ç‰Œâ€ï¼ˆåªæœ‰é“¶è¡ŒçŸ¥é“ä½ æ˜¯è°ï¼‰ |
| **CSRF Token** | é“¶è¡ŒæŸœå‘˜é—®ä½ ï¼šâ€œä½ çœŸçš„æ˜¯å¼ ä¸‰å—ï¼Ÿè¯·è¯´å‡ºæˆ‘ä»¬åˆšæ‰çº¦å®šçš„æš—å·ã€‚â€ï¼ˆé˜²æ­¢åˆ«äººæ‹¿ç€ä½ çš„å·ç‰Œå†’å……ä½ ï¼‰ |
| **è®¤è¯ Tokenï¼ˆJWTï¼‰** | ä½ æœ‰ä¸€å¼ â€œVIP é‡‘å¡â€ï¼Œå¡ä¸Šæœ‰åŠ å¯†ä¿¡æ¯ï¼Œé“¶è¡Œæ‰«ä¸€ä¸‹å°±çŸ¥é“ä½ æ˜¯ VIPï¼Œä¸éœ€è¦æŸ¥ç³»ç»Ÿï¼ˆæ— çŠ¶æ€ï¼‰ |

---

## âœ… ä¸‰ã€ä½ ä¹‹å‰çš„â€œcookie + sessionâ€ vs ç°åœ¨çš„â€œtokenâ€æ¨¡å¼

### 1. **ä¼ ç»Ÿæ–¹å¼ï¼šCookie + Sessionï¼ˆDjango é»˜è®¤ï¼‰**

```text
ç”¨æˆ·ç™»å½•
   â†“
æœåŠ¡å™¨ç”Ÿæˆ session_id â†’ å­˜å…¥æ•°æ®åº“ï¼ˆå¦‚ Redisï¼‰
   â†“
é€šè¿‡ Set-Cookie è¿”å›ç»™æµè§ˆå™¨
   â†“
æµè§ˆå™¨åç»­è¯·æ±‚è‡ªåŠ¨å¸¦ä¸Š Cookie: sessionid=abc123
   â†“
æœåŠ¡å™¨æŸ¥æ•°æ®åº“ï¼ŒçŸ¥é“ä½ æ˜¯è°
```

- âœ… å®‰å…¨ï¼šsession å­˜åœ¨æœåŠ¡å™¨ï¼Œå‰ç«¯ä¸æ¥è§¦æ•æ„Ÿä¿¡æ¯
- âŒ ç¼ºç‚¹ï¼šéœ€è¦æœåŠ¡å™¨å­˜å‚¨ï¼Œä¸é€‚åˆåˆ†å¸ƒå¼ã€å¾®æœåŠ¡

### 2. **ç°ä»£æ–¹å¼ï¼šTokenï¼ˆå¦‚ JWTï¼‰**

```text
ç”¨æˆ·ç™»å½•
   â†“
æœåŠ¡å™¨ç”Ÿæˆ JWT tokenï¼ˆåŒ…å«ç”¨æˆ·ä¿¡æ¯ + ç­¾åï¼‰
   â†“
è¿”å›ç»™å‰ç«¯ï¼ˆä¸å­˜æœåŠ¡å™¨ï¼‰
   â†“
å‰ç«¯æ¯æ¬¡è¯·æ±‚å¸¦ä¸Š Authorization: Bearer <token>
   â†“
æœåŠ¡å™¨éªŒè¯ç­¾åï¼Œè§£æç”¨æˆ·ä¿¡æ¯
```

- âœ… ä¼˜ç‚¹ï¼šæ— çŠ¶æ€ã€é€‚åˆå‰åç«¯åˆ†ç¦»ã€å¾®æœåŠ¡
- âŒ ç¼ºç‚¹ï¼štoken ä¸€æ—¦ç­¾å‘ï¼Œæ— æ³•ä¸»åŠ¨å¤±æ•ˆï¼ˆé™¤éåŠ é»‘åå•ï¼‰

---

## âœ… å››ã€å…³é”®ç»“è®ºï¼šCSRF Token å’Œ è®¤è¯ Token å¯ä»¥å…±å­˜ï¼

åœ¨ç°ä»£åº”ç”¨ä¸­ï¼Œ**ä½ å¯èƒ½åŒæ—¶éœ€è¦ä¸¤ç§ token**ï¼š

```http
POST /api/order HTTP/1.1
Host: example.com
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
X-CSRFToken: abc123xyz456...

{
  "product": "iPhone"
}
```

- `Authorization`ï¼šè¯æ˜â€œæˆ‘æ˜¯ç”¨æˆ· Aâ€
- `X-CSRFToken`ï¼šè¯æ˜â€œè¿™ä¸ªè¯·æ±‚æ˜¯æˆ‘ä¸»åŠ¨å‘èµ·çš„ï¼Œä¸æ˜¯æ¶æ„ç½‘ç«™ä¼ªé€ çš„â€

> ğŸ”¥ å³ä½¿ä½ ç”¨äº† JWTï¼Œ**å¦‚æœä½ çš„å‰ç«¯æ˜¯æµè§ˆå™¨ï¼ˆHTML é¡µé¢ï¼‰**ï¼Œä»ç„¶éœ€è¦ CSRF ä¿æŠ¤ï¼

---

## âœ… äº”ã€ä»€ä¹ˆæ—¶å€™å¯ä»¥ä¸ç”¨ CSRF Tokenï¼Ÿ

åªæœ‰åœ¨ä»¥ä¸‹æƒ…å†µå¯ä»¥**å®‰å…¨åœ°å…³é—­ CSRF æ£€æŸ¥**ï¼š

| åœºæ™¯ | è¯´æ˜ |
|------|------|
| âœ… **çº¯ API åç«¯ + ç§»åŠ¨ App** | App ä¸ä½¿ç”¨ cookieï¼Œä¸ä¼šè¢«æµè§ˆå™¨ CSRF æ”»å‡» |
| âœ… **ä½¿ç”¨ JWT + localStorage + ä¸ç”¨ cookie** | å¹¶ä¸”è®¾ç½® `SameSite=None` æˆ–å®Œå…¨ä¸ç”¨ session |
| âœ… **ä½¿ç”¨ OAuth / ç¬¬ä¸‰æ–¹ç™»å½•** | è®¤è¯æµç¨‹ç”±ç¬¬ä¸‰æ–¹ç®¡ç† |

ä½†å¦‚æœä½ çš„å‰ç«¯æ˜¯ **æµè§ˆå™¨æ¸²æŸ“çš„ HTML é¡µé¢**ï¼Œå¹¶ä¸”ä½¿ç”¨äº† **cookie æˆ– session**ï¼Œ**å°±å¿…é¡»ä¿ç•™ CSRF ä¿æŠ¤**ã€‚

---

## âœ… æ€»ç»“ï¼šä¸€å¥è¯ææ‡‚

> **CSRF Token æ˜¯â€œé˜²ä¼ªé€ â€çš„æš—å·ï¼Œè®¤è¯ Token æ˜¯â€œä½ æ˜¯è°â€çš„èº«ä»½è¯ã€‚å®ƒä»¬ä¸æ˜¯åŒä¸€ä¸ªä¸œè¥¿ï¼Œä½†å¯ä»¥ä¸€èµ·ç”¨ã€‚**

| ä½ é—®çš„é—®é¢˜ | å›ç­” |
|----------|------|
| â€œtoken æ˜¯ä¸æ˜¯å°±æ˜¯ CSRF tokenï¼Ÿâ€ | âŒ ä¸æ˜¯ï¼Œè¿™æ˜¯ä¸¤ç§ä¸åŒçš„å®‰å…¨æœºåˆ¶ |
| â€œç°åœ¨éƒ½ç”¨ token ç™»å½•â€ | âœ… é€šå¸¸æŒ‡ JWT è¿™ç±»è®¤è¯ token |
| â€œé‚£ CSRF token è¿˜è¦å—ï¼Ÿâ€ | âœ… å¦‚æœæ˜¯æµè§ˆå™¨å‰ç«¯ï¼Œ**ä»ç„¶éœ€è¦ï¼** |

---

ä½ ç°åœ¨å·²ç»ä»â€œç”¨å·¥å…·â€èµ°å‘äº†â€œç†è§£åŸç†â€ï¼Œè¿™ç§æ€è€ƒæ–¹å¼éå¸¸æ£’ï¼ç»§ç»­æ·±å…¥ï¼Œä½ ä¼šè¶Šæ¥è¶Šæ¥è¿‘ Web å®‰å…¨çš„æ ¸å¿ƒï¼ğŸ’ªğŸš€

å¦‚æœä½ æ¥ä¸‹æ¥æƒ³å­¦ JWTã€OAuthã€æˆ–å‰åç«¯åˆ†ç¦»é‰´æƒï¼Œæˆ‘ä¹Ÿå¯ä»¥ç»§ç»­å¸®ä½ æ¢³ç†ï¼ğŸ˜Š