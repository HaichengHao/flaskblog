ä½ æå‡ºçš„é—®é¢˜éå¸¸å…³é”®ï¼ğŸ‘

> âœ… **â€œç”¨æˆ· A èƒ½åˆ æ”¹ç”¨æˆ· B çš„æ–‡ç« â€** æ˜¯ä¸€ä¸ªå…¸å‹çš„ **è¶Šæƒæ¼æ´ï¼ˆInsecure Direct Object Reference, IDORï¼‰**ï¼Œå±äºä¸¥é‡å®‰å…¨é—®é¢˜ã€‚

ä½ å·²ç»æ„è¯†åˆ°è¿™ä¸ªé—®é¢˜ï¼Œè¯´æ˜ä½ çš„å¼€å‘æ€ç»´æ­£åœ¨ä»â€œåŠŸèƒ½å®ç°â€èµ°å‘â€œå®‰å…¨è®¾è®¡â€ï¼Œè¿™æ˜¯è´¨çš„é£è·ƒï¼ğŸ”¥

---

## ğŸ¯ é—®é¢˜æ ¹æºåˆ†æ

å½“å‰ä»£ç çš„é—®é¢˜åœ¨äºï¼š

```python
# âŒ åªæ ¹æ® aid æŸ¥è¯¢æ–‡ç« ï¼Œæ²¡æœ‰éªŒè¯ ownershipï¼ˆæ‰€æœ‰æƒï¼‰
aid = request.args.get('aid', int)
article = Article.query.get(aid)

# ç„¶åç›´æ¥åˆ é™¤æˆ–ä¿®æ”¹
db.session.delete(article)
db.session.commit()
```

ğŸ‘‰ **ä»»ä½•äººéƒ½å¯ä»¥é€šè¿‡ä¿®æ”¹ URL ä¸­çš„ `aid=2` å˜æˆ `aid=100` æ¥åˆ æ”¹åˆ«äººçš„æ–‡ç« ã€‚**

---

## âœ… è§£å†³æ–¹æ¡ˆï¼š**åŒé‡éªŒè¯ï¼ˆOwnership Checkï¼‰**

åœ¨æ‰§è¡Œä»»ä½•ä¿®æ”¹æˆ–åˆ é™¤æ“ä½œå‰ï¼Œå¿…é¡»éªŒè¯ï¼š
1. ç”¨æˆ·æ˜¯å¦ç™»å½• âœ…
2. å½“å‰ç”¨æˆ·æ˜¯å¦æ˜¯è¯¥æ–‡ç« çš„ä½œè€… âœ…

---

## âœ… ä¿®å¤æ–¹æ¡ˆä¸€ï¼šæ¨èå†™æ³•ï¼ˆå¼ºæ ¡éªŒï¼‰

### âœ… 1. ä¿®æ”¹ `/mofy_article` å’Œ `/del_article` è·¯ç”±

#### ğŸ”§ ä¿®æ”¹ `mofya_route`ï¼ˆä¿®æ”¹æ–‡ç« ï¼‰

```python
@article_bp.route('/mofy_article', methods=['GET', 'POST'], endpoint='mofya')
def mofya_route():
    if request.method == 'GET':
        aid = request.args.get('aid', type=int)  # æ³¨æ„ï¼štype=intï¼Œä¸æ˜¯ int
        article = Article.query.get(aid)

        if not article:
            return 'æ–‡ç« ä¸å­˜åœ¨', 404

        # âœ… æ ¡éªŒï¼šå½“å‰ç™»å½•ç”¨æˆ·æ˜¯å¦æ˜¯æ–‡ç« ä½œè€…
        if article.user_id != g.userme.id:
            return 'æ‚¨æ— æƒç¼–è¾‘æ­¤æ–‡ç« ', 403  # 403 Forbidden

        return render_template('article/mofya.html', article=article)
```

#### ğŸ”§ ä¿®æ”¹ `dela_route`ï¼ˆåˆ é™¤æ–‡ç« ï¼‰

```python
@article_bp.route('/del_article', methods=['GET'], endpoint='dela')  # å»ºè®®ç”¨ GET æµ‹è¯•ï¼Œç”Ÿäº§å»ºè®® POST
def dela_route():
    aid = request.args.get('aid', type=int)
    article = Article.query.get(aid)

    if not article:
        return 'æ–‡ç« ä¸å­˜åœ¨', 404

    # âœ… æ ¡éªŒï¼šå½“å‰ç”¨æˆ·æ˜¯å¦æ˜¯æ–‡ç« ä½œè€…
    if article.user_id != g.userme.id:
        return 'æ‚¨æ— æƒåˆ é™¤æ­¤æ–‡ç« ', 403

    # âœ… å®‰å…¨åˆ é™¤
    db.session.delete(article)
    db.session.commit()

    return redirect('/manage_article')
```

---

## âœ… æ–¹æ¡ˆäºŒï¼šæ›´ä¼˜é›…çš„å†™æ³•ï¼ˆå…ˆæŸ¥å†åˆ ï¼Œä¸€è¡Œæå®šï¼‰

ä½ å¯ä»¥ç›´æ¥åœ¨æŸ¥è¯¢æ—¶å°±åŠ ä¸Šç”¨æˆ· ID æ¡ä»¶ï¼š

```python
@article_bp.route('/del_article', methods=['GET'], endpoint='dela')
def dela_route():
    aid = request.args.get('aid', type=int)

    # âœ… ä¸€è¡Œæå®šï¼šåªæŸ¥â€œå½“å‰ç”¨æˆ· + æŒ‡å®šIDâ€çš„æ–‡ç« 
    article = Article.query.filter_by(id=aid, user_id=g.userme.id).first()

    if not article:
        # å¯èƒ½æ–‡ç« ä¸å­˜åœ¨ï¼Œä¹Ÿå¯èƒ½ä¸æ˜¯ä½ çš„
        return 'æ–‡ç« ä¸å­˜åœ¨æˆ–æ‚¨æ— æƒæ“ä½œ', 404

    db.session.delete(article)
    db.session.commit()

    return redirect('/manage_article')
```

âœ… è¿™ç§å†™æ³•æ›´å®‰å…¨ï¼Œå› ä¸ºå³ä½¿ `aid` æ­£ç¡®ï¼Œå¦‚æœä¸æ˜¯ä½ çš„æ–‡ç« ï¼Œ`filter_by(user_id=...)` ä¹Ÿä¼šè¿”å› `None`ã€‚

---

## âœ… è¡¥å……ï¼šä¿®æ”¹æ–‡ç« æäº¤æ¥å£ï¼ˆPOSTï¼‰

å¦‚æœä½ æœ‰ä¿å­˜ä¿®æ”¹çš„ POST æ¥å£ï¼Œä¹Ÿå¿…é¡»åŠ æ ¡éªŒï¼š

```python
@article_bp.route('/mofy_article', methods=['POST'], endpoint='mofya_post')
def mofya_post():
    aid = request.form.get('aid', type=int)
    title = request.form.get('title')
    content = request.form.get('content')
    typeid = request.form.get('typeid')

    article = Article.query.get(aid)
    if not article or article.user_id != g.userme.id:
        return 'æ— æƒæ“ä½œ', 403

    article.title = title
    article.content = content
    article.type_id = typeid
    db.session.commit()

    return redirect('/manage_article')
```

---

## âœ… å‰ç«¯å»ºè®®ï¼šåªæ˜¾ç¤ºè‡ªå·±çš„æ–‡ç« é“¾æ¥

åœ¨ `/manage_article` é¡µé¢ä¸­ï¼Œåªå±•ç¤ºå½“å‰ç”¨æˆ·çš„æ–‡ç« ï¼Œå¹¶ä¸”åªç”Ÿæˆå¯æ“ä½œçš„æŒ‰é’®ï¼š

```html
<!-- manageuarticle.html -->
{% for article in articles %}
    <div>
        <h4>{{ article.title }}</h4>
        <p>ç‚¹å‡»é‡: {{ article.click_num }}</p>
        <!-- âœ… åªç»™è‡ªå·±æ–‡ç« æ˜¾ç¤ºç¼–è¾‘/åˆ é™¤æŒ‰é’® -->
        <a href="{{ url_for('article.mofya') }}?aid={{ article.id }}" class="btn btn-sm btn-warning">ç¼–è¾‘</a>
        <a href="{{ url_for('article.dela') }}?aid={{ article.id }}" class="btn btn-sm btn-danger" onclick="return confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')">åˆ é™¤</a>
    </div>
{% endfor %}
```

---

## âœ… æœ€ä½³å®è·µæ€»ç»“

| é˜²æŠ¤æªæ–½ | è¯´æ˜ |
|--------|------|
| ğŸ” æ‰€æœ‰æƒæ ¡éªŒ | æ¯æ¬¡æ“ä½œéƒ½æ£€æŸ¥ `article.user_id == current_user.id` |
| ğŸ”’ ä½¿ç”¨ `filter_by(user_id=..., id=...)` ä¸€æ¬¡æ€§æŸ¥è¯¢ | å‡å°‘é€»è¾‘åˆ†æ”¯ |
| ğŸš« ä¸è¦ç›¸ä¿¡å‰ç«¯ä¼ æ¥çš„ä»»ä½• ID | åç«¯å¿…é¡»é‡æ–°éªŒè¯ |
| ğŸ“ è¿”å›æ¨¡ç³Šé”™è¯¯ä¿¡æ¯ | å¦‚â€œæ–‡ç« ä¸å­˜åœ¨æˆ–æ— æƒè®¿é—®â€ï¼Œé¿å…æš´éœ²ä¿¡æ¯ |
| ğŸ”‘ ä½¿ç”¨ `g.userme.id` æ˜¯å®‰å…¨çš„ | å› ä¸ºå®ƒæ¥è‡ªç™»å½•éªŒè¯åçš„ session |

---

## âœ… å®‰å…¨ç­‰çº§å¯¹æ¯”

| å†™æ³• | å®‰å…¨ç­‰çº§ | è¯´æ˜ |
|------|----------|------|
| `Article.query.get(aid)` | âŒ å±é™© | ä»»ä½•äººéƒ½èƒ½æ“ä½œ |
| `Article.query.get(aid)` + `if article.user_id != uid` | âœ… åŸºç¡€é˜²æŠ¤ | æ¨è |
| `Article.query.filter_by(id=aid, user_id=uid).first()` | âœ…âœ… æ¨è | æ›´ç®€æ´å®‰å…¨ |

---

ğŸ¯ **ç»“è®º**ï¼š

ä½ ç°åœ¨çš„ç³»ç»Ÿåªè¦åŠ ä¸Šè¿™ä¸€è¡Œæ ¡éªŒï¼š

```python
if article.user_id != g.userme.id:
    return 'æƒé™ä¸è¶³', 403
```

æˆ–è€…ç›´æ¥ç”¨ï¼š

```python
article = Article.query.filter_by(id=aid, user_id=g.userme.id).first()
```

å°±èƒ½å½»åº•æœç»è¶Šæƒé—®é¢˜ï¼

ä½ ç°åœ¨ä¸ä»…å®ç°äº†åŠŸèƒ½ï¼Œè¿˜æŒæ¡äº† **Web å®‰å…¨çš„æ ¸å¿ƒæ€æƒ³**ï¼š**æ°¸è¿œä¸è¦ä¿¡ä»»ç”¨æˆ·è¾“å…¥ï¼Œå§‹ç»ˆåšæƒé™æ ¡éªŒ**ã€‚

éœ€è¦æˆ‘å¸®ä½ åŠ ä¸Šâ€œè½¯åˆ é™¤â€ï¼ˆæ ‡è®°åˆ é™¤è€Œéç‰©ç†åˆ é™¤ï¼‰æˆ–â€œæ“ä½œæ—¥å¿—â€åŠŸèƒ½å—ï¼ŸğŸ˜Š