{#{% extends 'base.html' %}#}
{#{% block title %}#}
{#    用户登录#}
{#{% endblock %}#}
{##}
{#{% block page_content %}#}
{#<div style="padding: 30px; padding-top: 20px; padding-bottom: 40px;">#}
{#    <h1 style="color: #556252">用户登录</h1>#}
{##}
{#    <form action="{{ url_for('user.login') }}" method="post" id="loginForm"  onsubmit="console.log('表单提交！', this.action, this.method);">#}
{#        <!-- 默认显示：用户名密码登录 -->#}
{#        <div id="passwordLogin">#}
{#            <div class="mb-3">#}
{#                <label for="exampleInputUsername" class="form-label">用户名</label>#}
{#                <input type="text" class="form-control" id="exampleInputUsername" name="username" value="{{ request.cookies.get('remember_username', '') }}">#}
{#            </div>#}
{#            <div class="mb-3">#}
{#                <label for="passwd" class="form-label">密码</label>#}
{#                <input type="password" class="form-control" id="passwd" name="password">#}
{#            </div>#}
{#            <div class="mb-3">#}
{#                <label for="exampleInputphone" class="form-label">手机号（可选）</label>#}
{#                <input type="text" class="form-control" id="exampleInputphone" name="phone" placeholder="用于验证码登录">#}
{#            </div>#}
{#        </div>#}
{##}
{#        <!-- 验证码登录（默认隐藏） -->#}
{#        <div id="verifyLogin" style="display: none;">#}
{#            <div class="mb-3">#}
{#                <label for="vcphone" class="form-label">输入手机号</label>#}
{#                <input type="text" class="form-control" id="vcphone" name="phone" required>#}
{#            </div>#}
{#            <div class="mb-3">#}
{#                <label for="vcget" class="form-label">验证码</label>#}
{#                <div class="d-flex gap-2">#}
{#                    <input type="text" class="form-control flex-grow-1" id="vcget" name="vcode" required>#}
{#                    <button class="btn btn-outline-success" type="button" id="sendVcodeBtn">#}
{#                        获取验证码#}
{#                    </button>#}
{#                </div>#}
{#            </div>#}
{#        </div>#}
{##}
{#        <!-- 公共部分：记住我 + 按钮 -->#}
{#        <div class="mb-3 form-check">#}
{#            <input type="checkbox" class="form-check-input" id="remember" name="remember">#}
{#            <label class="form-check-label" for="remember">记住我</label>#}
{#        </div>#}
{##}
{#        <button type="submit" class="btn btn-primary">登录</button>#}
{#        <button type="button" class="btn btn-secondary" onclick="togglePassword()" id="togtext">显示密码</button>#}
{#        <button type="button" class="btn btn-secondary" id="toggleModeBtn">手机验证码登录</button>#}
{#        <button type="button" class="btn btn-secondary" onclick="location.href='/register'">注册</button>#}
{#    </form>#}
{##}
{#    <!-- 错误提示 -->#}
{#    <div style="color: red; margin-top: 10px;" id="error">{{ errorinfo }}</div>#}
{#</div>#}
{#{% endblock %}#}
{##}
{#{% block myjs %}#}
{#<script>#}
{#    // 切换密码显示#}
{#    function togglePassword() {#}
{#        const passwordField = document.getElementById("passwd");#}
{#        const btn = document.getElementById("togtext");#}
{#        if (passwordField.type === "password") {#}
{#            passwordField.type = "text";#}
{#            btn.innerText = "隐藏密码";#}
{#        } else {#}
{#            passwordField.type = "password";#}
{#            btn.innerText = "显示密码";#}
{#        }#}
{#    }#}
{##}
{#    // 切换登录方式#}
{#    document.getElementById("toggleModeBtn").addEventListener("click", function () {#}
{#        const pwdLogin = document.getElementById("passwd");#}
{#        const verifyLogin = document.getElementById("verifyLogin");#}
{#        const toggleBtn = document.getElementById("toggleModeBtn");#}
{##}
{#        if (verifyLogin.style.display === "none") {#}
{#            // 切换到验证码登录#}
{#            pwdLogin.style.display = "none";#}
{#            verifyLogin.style.display = "block";#}
{#            toggleBtn.innerText = "用户名密码登录";#}
{#        } else {#}
{#            // 切换到密码登录#}
{#            verifyLogin.style.display = "none";#}
{#            pwdLogin.style.display = "block";#}
{#            toggleBtn.innerText = "手机验证码登录";#}
{#        }#}
{#    });#}
{##}
{#    // 模拟发送验证码（实际应调用后端接口）#}
{#    document.getElementById("sendVcodeBtn").addEventListener("click", function () {#}
{#        const phone = document.getElementById("vcphone").value;#}
{#        if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {#}
{#            alert("请输入正确的手机号");#}
{#            return;#}
{#        }#}
{#        // 这里可以调用 AJAX 发送验证码#}
{#        alert("验证码已发送（模拟）");#}
{#        // 实际项目：fetch('/api/send_vcode', { method: 'POST', body: { phone } })#}
{#    });#}
{#</script>#}
{#{% endblock %}#}


{% extends 'base.html' %}

{% block title %}
    用户登录
{% endblock %}

{% block page_content %}
    <div style="padding: 30px; padding-top: 20px; padding-bottom: 40px;">
        <h1 style="color: #556252">用户登录</h1>

        <!-- 添加 onsubmit 调试 -->
        <form action="{{ url_for('user.login') }}" method="post" id="loginForm"
              onsubmit="console.log('✅ 表单即将提交！', this.action);">
            <!-- 默认显示：用户名密码登录 -->
            <div id="passwordLogin">
                <div class="mb-3">
                    <label for="username" class="form-label">用户名</label>
                    <input type="text" class="form-control"
                           id="username"
                           name="username"
                           value="{{ request.cookies.get('remember_username', '') }}"
                           autocomplete="username">
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">密码</label>
                    <input type="password" class="form-control"
                           id="password"
                           name="password"
                           autocomplete="current-password">
                </div>
            </div>

            <!-- 验证码登录（默认隐藏） -->
            <div id="verifyLogin" style="display: none;">
                <div class="mb-3">
                    <label for="vcphone" class="form-label">输入手机号</label>
                    <input type="text" class="form-control"
                           id="vcphone"
                           name="phone"
                           autocomplete="tel">
                </div>
                <div class="mb-3">
                    <label for="vcget" class="form-label">验证码</label>
                    <div class="d-flex gap-2">
                        <input type="text" class="form-control flex-grow-1"
                               id="vcget"
                               name="vcode"
                               >
                        <button class="btn btn-outline-success" type="button" id="sendVcodeBtn">
                            获取验证码
                        </button>
                    </div>
                </div>
            </div>

            <!-- 公共部分：记住我 + 按钮 -->
            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="remember" name="remember">
                <label class="form-check-label" for="remember">记住我</label>
            </div>

            <button type="submit" class="btn btn-primary">登录</button>
            <button type="button" class="btn btn-secondary" onclick="togglePassword()" id="togtext">显示密码</button>
            <button type="button" class="btn btn-secondary" id="toggleModeBtn">手机验证码登录</button>
            <button type="button" class="btn btn-secondary" onclick="location.href='/register'">注册</button>
        </form>

        <!-- 错误提示 -->
        <div style="color: red; margin-top: 10px;" id="error">{{ errorinfo }}</div>
    </div>
{% endblock %}

{% block myjs %}
    <script>
        // 切换密码显示
        function togglePassword() {
            const passwordField = document.getElementById("password");
            const btn = document.getElementById("togtext");

            if (!passwordField) {
                console.error("❌ 找不到密码输入框！");
                return;
            }

            if (passwordField.type === "password") {
                passwordField.type = "text";
                btn.innerText = "隐藏密码";
            } else {
                passwordField.type = "password";
                btn.innerText = "显示密码";
            }
        }

        // 切换登录方式
        document.getElementById("toggleModeBtn").addEventListener("click", function () {
            const pwdLogin = document.getElementById("passwordLogin");   // ✅ 修复：原来是 passwd
            const verifyLogin = document.getElementById("verifyLogin");
            const toggleBtn = document.getElementById("toggleModeBtn");
            const phoneInput = document.getElementById("vcphone");
            const vcodeInput = document.getElementById("vcget");
            if (!pwdLogin || !verifyLogin) {
                console.error("❌ 找不到登录容器！");
                return;
            }

            if (verifyLogin.style.display === "none") {
                // 切换到验证码登录
                pwdLogin.style.display = "none";
                verifyLogin.style.display = "block";
                toggleBtn.innerText = "用户名密码登录";
                phoneInput.required = true;
                vcodeInput.required = true;
            } else {
                // 切换到密码登录
                verifyLogin.style.display = "none";
                pwdLogin.style.display = "block";
                toggleBtn.innerText = "手机验证码登录";
                phoneInput.required = false;
                vcodeInput.required = false;
            }
        });

        // 模拟发送验证码
        document.getElementById("sendVcodeBtn").addEventListener("click", function () {
            const phoneInput = document.getElementById("vcphone");
            const phone = phoneInput.value.trim();
            /*获取输入的验证码*/
            const vcode = document.getElementById("vcode");


            if (!phone) {
                alert("请输入手机号");
                phoneInput.focus();
                return;
            }

            if (!/^1[3-9]\d{9}$/.test(phone)) {
                alert("请输入正确的手机号");
                phoneInput.focus();
                return;
            }


            /*如果各个验证都没有问题那就进行验证码的验证操作*/
            $.get('{{ url_for('user.sendmsg') }}',{phone:phone},function (data){

            })
            alert("验证码已发送（模拟）");
            // 实际项目中调用 API
            // fetch('/api/send_vcode', { method: 'POST', body: JSON.stringify({ phone }) })
        });
    </script>
{% endblock %}